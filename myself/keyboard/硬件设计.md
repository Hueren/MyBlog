## 原理图设计

### 主控

考虑到支持Vial固件和支持多种灯效的原因，主控芯片选择性能较强的32位单片机。国产APM32F103CBT6。

APM32的最小系统比较简单，只需要必要的供电、时钟以及复位按键。

需要注意的是在制作完成时烧录固件程序时，采用bootloader，为了每次更新固件不需要重新烧录bootloader,需将boot0接地。<mark>非常重要</mark>

<img title="" src="https://telegraph-image666.pages.dev/file/f5e29f8e05b32a2687e18.png" alt="" width="583">

### 电源

考虑到键盘体积小的情况，选用的LDO芯片尽量外围电路少和体积小

设计采用RT9193芯片。

<img title="" src="https://telegraph-image666.pages.dev/file/2d66f6bb3faab3c6aa4e7.png" alt="" width="356">

### TypeC

采用主流的TypeC接口，方便连接。

因为键盘是通过USB与电脑通信，根据设计需求需要将USB_D+通过1.5k电阻进行上拉。

##### 为什么一定要上拉，而且是1.5k？

<mark>解释参考网络：</mark>

USB主机是如何检测到，到插入的设备呢？在USB集线器的每个下游端口的D+ D-上，分别接了一个15K的下拉电阻到地，这样，当集线器的端口悬空没有设备插入时，输入端就被这两个下拉电阻拉到了低电平，而在USB的设备端，在D+或者D-上接了一个1.5K的上拉电阻到3.3V的电源，1.5K的上拉电阻是接在D+还是D-上，有设备的速度来决定，对于全速设备和高速设备，上拉电阻是接在D+上的，而低速设备的上拉电阻则是接在D-上。

当设备插入到集线器时，接了上拉电阻的那条数据线的电压由1.5K的上拉和15K的下拉分压决定，结果大概在3V（3.3/1.5+15）* 1.5=3V），这对于集线器的接收端来说，是一个高电平信号，集线器检测到这个状态后，它就报告给USB主控制器，这样就检测到设备的插入了，集线器根据检测到的被拉高的数据线是D+还是D-来判断插入的是什么速度类型的设备，USB高速设备先是被识别为全速设备，然后通过集线器和设备的通信确认，再切换到高速设备，在高速模式下，是电流传输模式，这时要将D+上的上拉电阻断开。

这个如果这个1.5K是其他值，那么D+/D-上拉分压之后的电平就会发生变化，如果再遇到电压纹波，那么就有可能不会被检测到，这个就是1.5K的由来。

<img title="" src="https://telegraph-image666.pages.dev/file/c2078ac0aa07905f01c02.png" alt="" width="598">

### 按键

按键采用热插拔形式，使用的是凯华热插拔轴座。

键盘的按键连接一般分为两种形式

1.矩阵连接

2.独立连接

本次目标为设计一把小配列键盘，并且AMP32的I/O口数量足够，因此采用独立连接的形式，<mark>用此种方法可以省去二极管</mark>降低成本。

<img title="" src="https://telegraph-image666.pages.dev/file/5fd989c6dbf43fe8daccb.png" alt="" width="546">

### 灯光

采用WS2812B(6028反贴4脚)

通过PWM信号进行驱动。灯珠之间相互串联，在设计时记得将信号输入引脚接入单片机能输出PWM信号的引脚。

### 烧录

不要忘记预留程序烧录引脚。推荐使用ST-LINK进行烧录。
