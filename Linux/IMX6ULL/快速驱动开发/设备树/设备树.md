# 设备树

设备树的作用就是描述一个硬件平台的硬件资源。这个“设备树”可以被bootloader(uboot)传递到内核， 内核可以从设备树中获取硬件信息。

---

i.MX6ULL芯片的硬件资源写到一个单独的设备树文件里面一般使用“.dtsi”后缀

---

| 名称  | 含义                                                                                    |
|:---:| ------------------------------------------------------------------------------------- |
| DTS | 是一种ASII 文本格式的设备树描述，也是我们要编写的设备树源码，一般一个.dts文件对应一个硬件平台，位于Linux源码的“/arch/arm/boot/dts”目录下 |
| DTC | 编译设备树源码的工具，一般情况下我们需要手动安装这个编译工具                                                        |
| DTB | 设备树源码编译生成的文件，类似于我们C语言中“.C”文件编译生成“.bin”文件                                              |

### 节点基本格式

```c
node-name@unit-address
{
    属性1 = ...
    属性2 = ...
    属性3 = ...
    子节点 ...
}
```

`node-name `用于指定节点的名称

`unit-address` 用于指定“单元地址”， 它的值要和节点“reg”属性的第一个地址一致。如果节点没有“reg”属性值，可以直接省略

### 节点标签

在imx6ull.dtsi头文件中，节点名“cpu”前面多了个“cpu0”,这个“cpu0”就是我们所说的节点标签。 通常节点标签是节点名的简写，所以它的作用是当其它位置需要引用时可以使用节点标签来向该节点中追加内容。

## 节点属性

 节点属性分为标准属性和自定义属性，也就是说我们在设备树中可以根据自己的实际需要定义、添加设备属性。 标准属性的属性名是固定的，自定义属性名可按照要求自行定义。

#### compatible属性

```c
compatible = "fsl,imx6ull-14x14-evk","fsl,imx6ull";
```

compatible属性值由一个或多个字符串组成，有多个字符串时使用“,”分隔开。

设备树中的每一个代表了一个设备的节点都要有一个compatible属性。 compatible是系统用来决定绑定到设备的设备驱动的关键。 compatible属性是用来查找节点的方法之一，另外还可以通过节点名或节点路径查找指定节点。

#### status属性

```c
status = "disable"
```

状态属性用于指示设备的“操作状态”，通过status可以去禁止设备或者启用设备。默认情况下不设置status属性设备是使能的。

#### #address-cell和#size-cells

属性值类型`u32`

```c
#address-cells = <1>;
#size-cells    = <1>;
```

#address-cells和 #size-cells属性同时存在，用于设置子节点的“reg”属性的“书写格式”。

#address-cells:   用于指定子节点reg属性“地址字段”所占的长度（单元格cells的个数）。 #size-cells        :   用于指定子节点reg属性“大小字段”所占的长度（单元格cells的个数）。

例如#address-cells=2，#size-cells=1，则reg内的数据含义为reg = <address address size address address size>， 因为每个cells是一个32位宽的数字，例如需要表示一个64位宽的地址时，就要使用两个address单元来表示。

 假如#address-cells=1，#size-cells=1，则reg内的数据含义为reg = < address size address size address size>。

#### reg属性

属性值类型：地址、长度数据对

reg属性描述设备资源在其父总线定义的地址空间内的地址。通常情况下用于表示一块寄存器的起始地址（偏移地址）和长度， 在特定情况下也有不同的含义。例如#address-cells = <1>，#size-cells = <1>，reg = <0x9000000 x4000>， 其中0x9000000表示的是地址，0x4000表示的是地址长度，这里的reg属性指定了起始地址为0x9000000，长度为0x4000的一块地址空间。

#### ranges属性

属性值类型：任意数量的 <子地址、父地址、地址长度>编码

```c

```

## 追加/修改节点内容

aliases子节点的作用就是为其他节点起一个别名

```c
aliases{
    can0 = &flexcan1
    can1 = &flexcan2
}
```

以`can0 = &flexcan1`为例。`flexcan1`是一个节点的名字， 设置别名后我们可以使用`can0`来指代`flexcan1`节点，与节点标签类似。 在设备树中更多的是为节点添加标签，没有使用节点别名，别名的作用是“快速找到设备树节点”。 在驱动中如果要查找一个节点，通常情况下我们可以使用“节点路径”一步步找到节点。 也可以使用别名“一步到位”找到节点。

#### chosen子节点

```c
chosen{
    stdout-path = &uart1;
}
```

chosen子节点不代表实际硬件，它主要用于给内核传递参数。 这里只设置了“stdout-path =&uart1;”一条属性，表示系统标准输出stdout使用串口uart1。 此外这个节点还用作uboot向linux内核传递配置参数的“通道”， 我们在Uboot中设置的参数就是通过这个节点传递到内核的， 这部分内容是uboot和内核自动完成的。
